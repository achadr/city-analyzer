# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Git Workflow

This project follows a **feature-branch-per-session** workflow:

### Start of Each Session:
1. **Ensure you're on main and up-to-date**:
   ```bash
   git checkout main
   git pull origin main
   ```

2. **Create a new feature branch**:
   ```bash
   git checkout -b feat/descriptive-feature-name
   ```
   - Use descriptive names like `feat/add-zone-metrics`, `fix/time-filter-bug`, etc.
   - Each session should have its own branch

3. **Work on your features** with regular commits

### End of Each Session:
1. **Push your feature branch**:
   ```bash
   git push -u origin feat/descriptive-feature-name
   ```

2. **Create PR and merge to main**:
   - Create PR via GitHub UI: `https://github.com/achadr/city-analyzer/pull/new/[branch-name]`
   - Or use GitHub CLI: `gh pr create` (requires authentication)
   - Review and merge the PR

3. **Sync local main** (optional but recommended):
   ```bash
   git checkout main
   git pull origin main
   git branch -d feat/descriptive-feature-name  # Delete local feature branch
   ```

### Benefits:
- ✅ **Isolated work**: Each session's changes are contained
- ✅ **Clean history**: Easy to track what was done each session
- ✅ **Reviewable**: Can review changes before merging
- ✅ **Revertable**: Easy to revert a session's work if needed

## Development Commands

- `npm run dev` — Start Vite development server (React app with HMR)
- `npm run build` — Compile TypeScript and build production bundle
- `npm run preview` — Preview production build locally
- `npm run generate` — Generate synthetic population data (runs src/generators/populationGenerator.ts)

## Environment Setup

Create a `.env` file in the project root with your Mapbox access token:
```
VITE_MAPBOX_TOKEN=your_actual_mapbox_token_here
```

The application will display an error message if the token is missing.

## Project Architecture

This is a React + TypeScript + Mapbox GL application that visualizes population activity patterns in Paris. The project uses Vite for development and build tooling.

### Core Data Flow

**App.tsx** is the root component that manages all application state and coordinates between:
- `MapView` — Mapbox GL map component that renders GeoJSON layers
- `SidePanel` — Left panel with layer visibility and age filter controls
- `PersonPanel` — Right panel that displays selected person details and activity chain
- `TimeSlider` — Bottom slider to filter activities by time of day

State flows down from App.tsx to all child components. User interactions flow back up through callback props (`onPersonSelect`, `onActivityChainToggle`, etc.).

### Data Architecture

**Population Data**: The app loads `/data/population.json`, which contains synthetic person records generated by `populationGenerator.ts`. Each person has:
- Demographics (id, age, sex, firstName, lastName)
- Activities array with coordinates, time ranges, zones, and transport methods

**GeoJSON Conversion**: MapView.tsx converts population.json into GeoJSON FeatureCollection:
- Each person's activities become separate Point features
- Properties include precomputed `start` and `end` minutes for fast filtering
- Features are stored in `allFeaturesRef` and filtered before being passed to Mapbox

**Arrondissement Boundaries**: `/data/paris-arrondissements.geojson` provides Paris district polygons used by the generator and displayed as a map layer.

### Key Filtering System

**Time Filtering** (src/maps/utils/time.ts):
- Activities have startTime/endTime strings (e.g., "08:00", "17:00")
- Converted to minutes (0-1439) and stored in feature properties as `start` and `end`
- `filterByTime(features, minutes)` filters the entire FeatureCollection in JavaScript before passing to Mapbox
- This approach keeps cluster counts accurate for the selected time

**Age Filtering** (src/maps/utils/age.ts):
- Implemented using Mapbox filter expressions, not JavaScript filtering
- `makeAgeFilter(ageBand)` returns a Mapbox FilterSpecification
- Applied to the "unclustered-point" layer via `map.setFilter()`
- JavaScript filtering via `filterByAgeBand()` is applied to the source data so clusters reflect the age filter

### Activity Chain Visualization

When a person is selected and "Show Activity Chain" is toggled:
1. App.tsx updates `showActivityChain` state and passes `activityChainData` to MapView
2. MapView switches from showing filtered population data to showing only that person's activity locations
3. `createActivityChainFeatures()` generates Point features for each unique activity location
4. `createActivityChainLines()` generates a LineString connecting activities in sequence
5. The "activity-chain-lines" layer becomes visible with blue connecting lines
6. Cluster layers are hidden, and point interaction handlers are temporarily removed
7. The map shows the person's daily journey with connecting lines and transport mode labels in PersonPanel

### Mapbox Clustering Configuration

The "population" GeoJSON source uses:
- `cluster: true` with `clusterRadius: 40` and `clusterMaxZoom: 13`
- Custom `clusterProperties` to aggregate activity counts (home, work, education, leisure)
- These counts could be used for pie chart markers (the `drawPie()` function exists but marker updates are currently disabled)

### Centralized Type System

All shared TypeScript types are in `src/types/index.ts`:
- Core data types: Person, Activity, Coordinates
- UI state types: LayersState, FiltersState, AgeBand
- Callback types: PersonSelectionCallback, ActivityChainToggleCallback
- Feature-specific types: ActivityChainData

This ensures type consistency across the entire application.

### Centralized Constants and Styles

**src/constants/index.ts** — All magic numbers and configuration:
- Map styling constants (point sizes, stroke widths, cluster settings)
- Color palettes for activities, clusters
- UI dimensions (panel width, icon sizes)
- Map configuration (initial center/zoom, style URL)

**src/styles/index.ts** — Reusable style objects:
- Color system (primary, gray scale, semantic colors)
- Spacing scale, border radius, font sizes
- Common component styles (PANEL_STYLES, BUTTON_STYLES)
- This avoids inline style duplication and makes theming consistent

### Component Organization

- **src/components/** — UI components (SidePanel, PersonPanel, TimeSlider, icons/)
- **src/maps/** — Map-related components and utilities
  - MapView.tsx — Main map component
  - utils/ — Time and age filtering utilities
- **src/generators/** — Data generation scripts (populationGenerator.ts uses Turf.js for spatial operations)
- **src/types/**, **src/constants/**, **src/styles/** — Shared resources extracted for reusability

### Technology Stack

- **React 19** with functional components and hooks
- **TypeScript** with strict mode enabled
- **Mapbox GL JS** for map rendering and GeoJSON visualization
- **Turf.js** (@turf/turf) for geospatial analysis (used in population generator)
- **Vite** for fast development and optimized production builds
- **Tailwind CSS** (configured but primarily using inline styles with centralized style objects)
